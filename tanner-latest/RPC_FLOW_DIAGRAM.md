# 🔄 Схема работы RPC API в RTK Query

## Поток запроса

```
┌─────────────────────────────────────────────────────────────┐
│                    React Component                           │
│                                                              │
│  const { data } = useGetUsersQuery()                         │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    RTK Query Hook                            │
│                                                              │
│  query: () => ({                                             │
│    method: 'users.list',                                     │
│    params: { limit: 10 }                                     │
│  })                                                          │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              Custom RPC baseQuery                            │
│                                                              │
│  POST /api/rpc                                               │
│  {                                                           │
│    "method": "users.list",                                   │
│    "params": { "limit": 10 }                                 │
│  }                                                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Backend Server                            │
│                                                              │
│  Единый POST endpoint: /api/rpc                              │
│  Обрабатывает все методы                                     │
└─────────────────────────┬───────────────────────────────────┘
                          │
              ┌───────────┴───────────┐
              │                       │
              ▼                       ▼
        ┌──────────┐            ┌──────────┐
        │ Success  │            │  Error   │
        └────┬─────┘            └────┬─────┘
             │                       │
             ▼                       ▼
    ┌────────────────┐      ┌────────────────┐
    │ {              │      │ {              │
    │   "result": [] │      │   "error": {   │
    │ }              │      │     "code": 403│
    │                │      │   }            │
    └────┬───────────┘      └────┬───────────┘
         │                       │
         └───────────┬───────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │   RPC baseQuery        │
        │   Парсит ответ         │
        └────────────┬───────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
    ┌─────────┐            ┌─────────┐
    │ return  │            │ return  │
    │ { data }│            │ { error }│
    └────┬────┘            └────┬────┘
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │   Middleware           │
        │   (если ошибка)        │
        │   - 401 → redirect     │
        │   - 500+ → log         │
        └───────────┬───────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │   Component            │
        │   Получает data/error  │
        └───────────────────────┘
```

## Сравнение REST vs RPC

### REST API (стандартный подход):

```
GET    /api/users          → Список пользователей
GET    /api/users/123      → Получить пользователя
POST   /api/users          → Создать пользователя
PUT    /api/users/123      → Обновить пользователя
DELETE /api/users/123      → Удалить пользователя
```

### RPC API (единый endpoint):

```
POST /api/rpc
{
  "method": "users.list",
  "params": {}
}

POST /api/rpc
{
  "method": "users.get",
  "params": { "id": 123 }
}

POST /api/rpc
{
  "method": "users.create",
  "params": { "name": "John" }
}

POST /api/rpc
{
  "method": "users.update",
  "params": { "id": 123, "name": "John Doe" }
}

POST /api/rpc
{
  "method": "users.delete",
  "params": { "id": 123 }
}
```

## Структура файлов

```
src/
├── shared/
│   ├── api/
│   │   ├── rpc-base-query.ts ← Custom baseQuery
│   │   │   └── createRPCBaseQuery()
│   │   │       ├── Формирует POST запрос
│   │   │       ├── Добавляет токен
│   │   │       └── Парсит ответ
│   │   │
│   │   └── my-rpc-api.ts ← Ваш API
│   │       └── createApi({
│   │             baseQuery: createRPCBaseQuery(),
│   │             endpoints: {
│   │               getUsers: { method: 'users.list' },
│   │               createUser: { method: 'users.create' }
│   │             }
│   │           })
│   │
│   ├── store/
│   │   └── index.ts ← Store
│   │       └── reducer: { [myApi.reducerPath]: myApi.reducer }
│   │
│   └── middleware/
│       └── rtk-query-error-logger.ts ← Обработка ошибок
│
└── components/
    └── MyComponent.tsx ← Использование
        └── useGetUsersQuery()
```

## Детальная схема baseQuery

```typescript
┌─────────────────────────────────────────────────────────────┐
│  createRPCBaseQuery(baseUrl, endpoint)                       │
│                                                              │
│  return async (args, api, extraOptions) => {                │
│                                                              │
│    1. Преобразование args                                    │
│       ┌──────────────────────────────────┐                  │
│       │ string → { method: string }      │                  │
│       │ object → { method, params }      │                  │
│       └──────────────────────────────────┘                  │
│                                                              │
│    2. Формирование запроса                                   │
│       ┌──────────────────────────────────┐                  │
│       │ POST ${baseUrl}${endpoint}       │                  │
│       │ Headers:                         │                  │
│       │   - Content-Type: application/json│                 │
│       │   - Authorization: Bearer token  │                  │
│       │ Body:                            │                  │
│       │   { method, params }             │                  │
│       └──────────────────────────────────┘                  │
│                                                              │
│    3. Отправка запроса                                       │
│       ┌──────────────────────────────────┐                  │
│       │ fetch(url, options)              │                  │
│       └──────────────────────────────────┘                  │
│                                                              │
│    4. Парсинг ответа                                         │
│       ┌──────────────────────────────────┐                  │
│       │ const data = await response.json()│                 │
│       └──────────────────────────────────┘                  │
│                                                              │
│    5. Проверка на ошибки                                     │
│       ┌──────────────────────────────────┐                  │
│       │ if (data.error)                  │                  │
│       │   return { error: {...} }        │                  │
│       │ else                             │                  │
│       │   return { data: data.result }   │                  │
│       └──────────────────────────────────┘                  │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
```

## Пример полного цикла

### 1. Компонент делает запрос:

```typescript
const { data, error } = useGetUsersQuery()
```

### 2. RTK Query вызывает endpoint:

```typescript
getUsers: build.query({
  query: () => ({
    method: 'users.list',
    params: { limit: 10 }
  })
})
```

### 3. baseQuery формирует HTTP запрос:

```http
POST /api/rpc HTTP/1.1
Content-Type: application/json
Authorization: Bearer eyJhbGc...

{
  "method": "users.list",
  "params": {
    "limit": 10
  }
}
```

### 4. Сервер обрабатывает и отвечает:

```json
{
  "result": [
    { "id": 1, "name": "John" },
    { "id": 2, "name": "Jane" }
  ]
}
```

### 5. baseQuery парсит ответ:

```typescript
return { data: response.result }
```

### 6. Компонент получает данные:

```typescript
data = [
  { id: 1, name: "John" },
  { id: 2, name: "Jane" }
]
```

## Обработка ошибок

```
┌─────────────────────────────────────────────────────────────┐
│                    Ошибка от сервера                         │
│                                                              │
│  {                                                           │
│    "error": {                                                │
│      "code": 403,                                            │
│      "message": "Access denied"                              │
│    }                                                         │
│  }                                                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              baseQuery парсит ошибку                         │
│                                                              │
│  return {                                                    │
│    error: {                                                  │
│      status: 403,                                            │
│      data: "Access denied"                                   │
│    }                                                         │
│  }                                                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Middleware                                │
│                                                              │
│  if (status === 401) → redirect to /login                   │
│  if (status >= 500) → console.error()                       │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Component                                 │
│                                                              │
│  if (error.status === 403) {                                 │
│    return <div>Нет доступа</div>                             │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
```

## Преимущества архитектуры

```
┌──────────────────────────────────────────────────────────┐
│                    Преимущества                           │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ✓ Единая точка входа                                    │
│    └─ Все запросы на один URL                            │
│                                                          │
│  ✓ Гибкость                                              │
│    └─ Легко добавлять новые методы                       │
│                                                          │
│  ✓ Типизация                                             │
│    └─ TypeScript знает типы всех методов                 │
│                                                          │
│  ✓ Кеширование                                           │
│    └─ RTK Query автоматически кеширует                   │
│                                                          │
│  ✓ Обработка ошибок                                      │
│    └─ Единая система для всех методов                    │
│                                                          │
│  ✓ Авторизация                                           │
│    └─ Токен добавляется автоматически                    │
│                                                          │
└──────────────────────────────────────────────────────────┘
```
