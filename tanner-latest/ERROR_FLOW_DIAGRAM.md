# Схема обработки ошибок RTK Query

## 🔄 Поток обработки ошибок

```
┌─────────────────────────────────────────────────────────────┐
│                    API Request (RTK Query)                   │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
                    ┌──────────┐
                    │ Response │
                    └─────┬────┘
                          │
              ┌───────────┴───────────┐
              │                       │
              ▼                       ▼
         ┌─────────┐            ┌─────────┐
         │ Success │            │  Error  │
         └─────────┘            └────┬────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │                                 │
                    ▼                                 ▼
        ┌───────────────────────┐      ┌──────────────────────┐
        │  Middleware (Global)  │      │  Component (Local)   │
        └───────────┬───────────┘      └──────────┬───────────┘
                    │                             │
        ┌───────────┴───────────┐     ┌───────────┴───────────┐
        │                       │     │                       │
        ▼                       ▼     ▼                       ▼
    ┌───────┐            ┌──────────┐ ┌──────┐         ┌──────┐
    │  401  │            │  500+    │ │ 403  │         │ 404  │
    │       │            │          │ │      │         │      │
    │ Auto  │            │   Log    │ │ Show │         │ Show │
    │Redirect│           │  Error   │ │Access│         │ Not  │
    │       │            │          │ │Denied│         │Found │
    └───────┘            └──────────┘ └──────┘         └──────┘
        │                     │            │                │
        ▼                     ▼            ▼                ▼
   /login              Console.error   Component      Component
                                        Render         Render
```

## 📊 Распределение ответственности

### 🔴 Middleware (Глобальный уровень)

**Обрабатывает критические ошибки:**

```
┌──────────────────────────────────────────────────────┐
│  Middleware: rtk-query-error-logger.ts               │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ✓ 401 Unauthorized                                  │
│    → Очистка токена                                  │
│    → Редирект на /login                              │
│                                                      │
│  ✓ 500+ Server Errors                                │
│    → Логирование в консоль                           │
│    → (Опционально) Toast уведомление                 │
│                                                      │
│  ✓ FETCH_ERROR / PARSING_ERROR                       │
│    → Логирование сетевых ошибок                      │
│    → (Опционально) Toast уведомление                 │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### 🟡 Component (Локальный уровень)

**Обрабатывает бизнес-логику:**

```
┌──────────────────────────────────────────────────────┐
│  Component: MyComponent.tsx                          │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ✓ 403 Forbidden                                     │
│    → Показать "Нет доступа"                          │
│    → Предложить альтернативу                         │
│                                                      │
│  ✓ 404 Not Found                                     │
│    → Показать "Не найдено"                           │
│    → Кнопка "Назад"                                  │
│                                                      │
│  ✓ 422 Validation Error                              │
│    → Показать ошибки формы                           │
│    → Подсветить поля                                 │
│                                                      │
│  ✓ Другие 4xx                                        │
│    → Специфичная обработка                           │
│                                                      │
└──────────────────────────────────────────────────────┘
```

## 🔧 Примеры кода

### Query (Получение данных)

```typescript
function UserProfile({ userId }: { userId: number }) {
  const { data, error, isLoading } = useGetUserByIdQuery(userId)

  if (isLoading) return <Loader />

  if (error && 'status' in error) {
    // 401 → обработан middleware (автоматический редирект)
    // 500+ → обработан middleware (логирование)
    
    // Обрабатываем только бизнес-ошибки:
    if (error.status === 403) {
      return <AccessDenied />
    }
    if (error.status === 404) {
      return <NotFound />
    }
  }

  return <div>{data?.name}</div>
}
```

### Mutation (Изменение данных)

```typescript
function CreateUser() {
  const [createUser] = useCreateUserMutation()

  const handleSubmit = async (data: UserData) => {
    try {
      await createUser(data).unwrap()
      // Успех
    } catch (error) {
      // 401 → обработан middleware
      // 500+ → обработан middleware
      
      // Обрабатываем только бизнес-ошибки:
      if (error?.status === 422) {
        // Показать ошибки валидации
      }
    }
  }

  return <form onSubmit={handleSubmit}>...</form>
}
```

## 🎨 Визуальная схема файлов

```
src/
├── main.tsx ← Redux Provider подключен
│
├── shared/
│   ├── api/
│   │   ├── base-api.ts ← Базовая конфигурация
│   │   └── users-api.ts ← Пример API
│   │
│   ├── store/
│   │   ├── index.ts ← Store + Middleware
│   │   └── hooks.ts ← Типизированные хуки
│   │
│   ├── middleware/
│   │   └── rtk-query-error-logger.ts ← Глобальная обработка
│   │
│   └── utils/
│       └── handle-rtk-error.tsx ← Утилиты
│
└── components/
    ├── UsersList.example.tsx ← Пример списка
    └── UserProfile.example.tsx ← Пример детальной страницы
```

## 🚦 Матрица обработки ошибок

| Статус | Где обрабатывается | Действие |
|--------|-------------------|----------|
| 401 | Middleware | Автоматический редирект на /login |
| 403 | Component | Показать "Нет доступа" |
| 404 | Component | Показать "Не найдено" |
| 422 | Component | Показать ошибки валидации |
| 500+ | Middleware | Логирование + Toast |
| FETCH_ERROR | Middleware | Логирование + Toast |
| PARSING_ERROR | Middleware | Логирование + Toast |

## 💡 Ключевые преимущества

1. **Разделение ответственности** - критические ошибки обрабатываются глобально
2. **Гибкость** - бизнес-логика обрабатывается локально
3. **Безопасность** - автоматическая обработка 401
4. **Удобство** - готовые утилиты для типичных сценариев
5. **Типизация** - полная поддержка TypeScript
