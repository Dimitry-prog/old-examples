name: Dependency Updates

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check for outdated packages
        run: |
          echo "## Outdated Packages Report" > outdated-report.md
          echo "" >> outdated-report.md

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
          if bun outdated --format=json > outdated.json 2>/dev/null; then
            echo "Found outdated packages:"
            cat outdated.json

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
            echo "### Production Dependencies" >> outdated-report.md
            echo "" >> outdated-report.md
            echo "| Package | Current | Latest | Type |" >> outdated-report.md
            echo "|---------|---------|--------|------|" >> outdated-report.md

            # ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSON Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð¾Ñ‚Ñ‡ÐµÑ‚ (ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
            echo "See full report in the workflow logs." >> outdated-report.md
          else
            echo "No outdated packages found or error occurred."
            echo "âœ… All packages are up to date!" >> outdated-report.md
          fi

      - name: Create issue for outdated packages
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
            let report = '';
            try {
              report = fs.readFileSync('outdated-report.md', 'utf8');
            } catch (error) {
              report = 'âŒ Failed to generate outdated packages report.';
            }

            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automated'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Weekly Dependency Update Report')
            );

            const issueBody = `# Weekly Dependency Update Report

            This is an automated report of outdated dependencies in the project.

            ${report}

            ## Actions Required

            - [ ] Review the outdated packages
            - [ ] Update critical security patches immediately
            - [ ] Plan updates for major version changes
            - [ ] Test thoroughly after updates

            ## Automation

            This issue is created automatically every Monday. Close it when all updates are reviewed.

            ---
            *Generated on: ${new Date().toISOString()}*`;

            if (existingIssue) {
              // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Weekly Dependency Update Report - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['dependencies', 'automated', 'maintenance']
              });

              console.log('Created new dependency update issue');
            }

  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ patch Ð²ÐµÑ€ÑÐ¸Ð¹
  auto-update-patches:
    name: Auto Update Patches
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-updates

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Update patch versions
        run: |
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ patch Ð²ÐµÑ€ÑÐ¸Ð¸ (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ)
          bun update --patch

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          if git diff --quiet package.json bun.lockb; then
            echo "No patch updates available"
            echo "has_updates=false" >> $GITHUB_ENV
          else
            echo "Patch updates found"
            echo "has_updates=true" >> $GITHUB_ENV
          fi

      - name: Run tests after updates
        if: env.has_updates == 'true'
        run: |
          bun install
          bun run type-check
          bun run lint
          bun run test:unit
          bun run build

      - name: Create PR for patch updates
        if: env.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'build(deps): update patch versions'
          title: 'build(deps): automated patch version updates'
          body: |
            ## Automated Dependency Updates

            This PR contains automated patch version updates for dependencies.

            ### Changes
            - Updated patch versions of dependencies
            - All tests pass
            - No breaking changes expected

            ### Verification
            - [x] TypeScript compilation passes
            - [x] Linting passes
            - [x] Unit tests pass
            - [x] Build succeeds

            This PR was created automatically by the dependency update workflow.

            **Safe to merge** - these are patch updates only.
          branch: automated/patch-updates
          labels: |
            dependencies
            automated
            patch-updates
          reviewers: |
            # Add your team members here
          draft: false

  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run security audit
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°ÑƒÐ´Ð¸Ñ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
          if ! bun audit --audit-level=high; then
            echo "Security vulnerabilities found!"

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
            bun audit --audit-level=low --json > security-report.json || true

            echo "SECURITY_ISSUES=true" >> $GITHUB_ENV
          else
            echo "No security issues found"
            echo "SECURITY_ISSUES=false" >> $GITHUB_ENV
          fi

      - name: Create security issue
        if: env.SECURITY_ISSUES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let securityReport = '';
            try {
              const reportData = fs.readFileSync('security-report.json', 'utf8');
              securityReport = '```json\n' + reportData + '\n```';
            } catch (error) {
              securityReport = 'Failed to read security report.';
            }

            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ security issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Security Vulnerabilities Detected')
            );

            const issueBody = `# ðŸš¨ Security Vulnerabilities Detected

            Automated security audit has detected vulnerabilities in dependencies.

            ## Security Report

            ${securityReport}

            ## Actions Required

            - [ ] Review all security vulnerabilities
            - [ ] Update affected packages immediately
            - [ ] Test the application after updates
            - [ ] Verify no functionality is broken

            ## Priority

            **HIGH PRIORITY** - Security vulnerabilities should be addressed immediately.

            ---
            *Generated on: ${new Date().toISOString()}*`;

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['security', 'dependencies', 'high-priority', 'automated']
              });

              console.log('Created security vulnerability issue');
            }
