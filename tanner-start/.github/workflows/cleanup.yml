name: Cleanup

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö workflow runs
  cleanup-runs:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Cleanup old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ workflows
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo
            });

            console.log(`Found ${workflows.data.workflows.length} workflows`);

            for (const workflow of workflows.data.workflows) {
              console.log(`Processing workflow: ${workflow.name}`);

              // –ü–æ–ª—É—á–∞–µ–º runs –¥–ª—è –∫–∞–∂–¥–æ–≥–æ workflow
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 100
              });

              // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 runs, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–¥–∞–ª—è–µ–º
              const runsToDelete = runs.data.workflow_runs.slice(50);

              console.log(`Deleting ${runsToDelete.length} old runs for ${workflow.name}`);

              for (const run of runsToDelete) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id
                  });
                  console.log(`Deleted run ${run.id}`);
                } catch (error) {
                  console.log(`Failed to delete run ${run.id}: ${error.message}`);
                }
              }
            }

  # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });

            console.log(`Found ${artifacts.data.artifacts.length} artifacts`);

            // –£–¥–∞–ª—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            let deletedCount = 0;

            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);

              if (createdAt < thirtyDaysAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner,
                    repo,
                    artifact_id: artifact.id
                  });
                  console.log(`Deleted artifact: ${artifact.name} (${artifact.created_at})`);
                  deletedCount++;
                } catch (error) {
                  console.log(`Failed to delete artifact ${artifact.id}: ${error.message}`);
                }
              }
            }

            console.log(`Deleted ${deletedCount} old artifacts`);

  # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–µ—à–µ–π
  cleanup-caches:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Cleanup old caches
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–µ—à–∏
              const caches = await github.rest.actions.getActionsCacheList({
                owner,
                repo,
                per_page: 100
              });

              console.log(`Found ${caches.data.actions_caches.length} caches`);

              // –£–¥–∞–ª—è–µ–º –∫–µ—à–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
              const sevenDaysAgo = new Date();
              sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

              let deletedCount = 0;

              for (const cache of caches.data.actions_caches) {
                const createdAt = new Date(cache.created_at);

                if (createdAt < sevenDaysAgo) {
                  try {
                    await github.rest.actions.deleteActionsCacheById({
                      owner,
                      repo,
                      cache_id: cache.id
                    });
                    console.log(`Deleted cache: ${cache.key} (${cache.created_at})`);
                    deletedCount++;
                  } catch (error) {
                    console.log(`Failed to delete cache ${cache.id}: ${error.message}`);
                  }
                }
              }

              console.log(`Deleted ${deletedCount} old caches`);
            } catch (error) {
              console.log(`Cache cleanup failed: ${error.message}`);
              // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º workflow, –µ—Å–ª–∏ –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
            }

  # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫
  cleanup-branches:
    name: Cleanup Merged Branches
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup merged branches
        run: |
          echo "Fetching all branches..."
          git fetch --all --prune

          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–ª–∏—Ç—ã –≤ main/master
          MAIN_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          echo "Main branch: $MAIN_BRANCH"

          # –ù–∞—Ö–æ–¥–∏–º –≤–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–ª–∏—Ç—ã
          MERGED_BRANCHES=$(git branch -r --merged origin/$MAIN_BRANCH | \
            grep -v "origin/$MAIN_BRANCH" | \
            grep -v "origin/HEAD" | \
            grep -v "origin/develop" | \
            grep -v "origin/staging" | \
            grep -v "origin/production" | \
            sed 's/origin\///' | \
            tr -d ' ')

          if [ -z "$MERGED_BRANCHES" ]; then
            echo "No merged branches to delete"
            exit 0
          fi

          echo "Found merged branches:"
          echo "$MERGED_BRANCHES"

          # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
          for branch in $MERGED_BRANCHES; do
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –≤ –≤–µ—Ç–∫–µ
            LAST_COMMIT_DATE=$(git log -1 --format="%ct" "origin/$branch" 2>/dev/null || echo "0")
            CURRENT_DATE=$(date +%s)
            DAYS_OLD=$(( (CURRENT_DATE - LAST_COMMIT_DATE) / 86400 ))

            if [ $DAYS_OLD -gt 30 ]; then
              echo "Deleting branch $branch (${DAYS_OLD} days old)"
              git push origin --delete "$branch" || echo "Failed to delete $branch"
            else
              echo "Keeping branch $branch (${DAYS_OLD} days old)"
            fi
          done

  # –û—Ç—á–µ—Ç –æ–± –æ—á–∏—Å—Ç–∫–µ
  cleanup-report:
    name: Cleanup Report
    runs-on: ubuntu-latest
    needs: [cleanup-runs, cleanup-artifacts, cleanup-caches, cleanup-branches]
    if: always()

    steps:
      - name: Generate cleanup report
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'Workflow Runs': '${{ needs.cleanup-runs.result }}',
              'Artifacts': '${{ needs.cleanup-artifacts.result }}',
              'Caches': '${{ needs.cleanup-caches.result }}',
              'Branches': '${{ needs.cleanup-branches.result }}'
            };

            let report = '# üßπ Daily Cleanup Report\n\n';
            report += `**Date:** ${new Date().toISOString().split('T')[0]}\n\n`;
            report += '## Results\n\n';

            for (const [task, result] of Object.entries(results)) {
              const emoji = result === 'success' ? '‚úÖ' : result === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
              report += `- ${emoji} **${task}:** ${result}\n`;
            }

            report += '\n## Summary\n\n';

            const successCount = Object.values(results).filter(r => r === 'success').length;
            const totalCount = Object.keys(results).length;

            if (successCount === totalCount) {
              report += 'üéâ All cleanup tasks completed successfully!';
            } else {
              report += `‚ö†Ô∏è ${successCount}/${totalCount} cleanup tasks completed successfully.`;
            }

            report += '\n\n---\n*This report is generated automatically by the cleanup workflow.*';

            console.log('Cleanup Report:');
            console.log(report);

            // –°–æ–∑–¥–∞–µ–º issue —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
            if (successCount < totalCount) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üßπ Cleanup Issues - ${new Date().toISOString().split('T')[0]}`,
                body: report,
                labels: ['maintenance', 'automated', 'cleanup']
              });
            }
