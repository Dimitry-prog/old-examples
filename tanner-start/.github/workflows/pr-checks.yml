name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, master, develop]

# –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—É—Å–∫–∏ –¥–ª—è —Ç–æ–≥–æ –∂–µ PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ PR
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.changes.outputs.src }}
      tests: ${{ steps.changes.outputs.tests }}
      docs: ${{ steps.changes.outputs.docs }}
      config: ${{ steps.changes.outputs.config }}
      workflows: ${{ steps.changes.outputs.workflows }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - 'src/**'
              - 'public/**'
              - 'index.html'
            tests:
              - 'src/**/*.test.*'
              - 'src/**/*.spec.*'
              - 'tests/**'
              - 'vitest.config.ts'
              - 'vitest.*.config.ts'
            docs:
              - '*.md'
              - 'docs/**'
              - 'src/docs/**'
            config:
              - 'package.json'
              - 'bun.lockb'
              - 'tsconfig.json'
              - 'vite.config.ts'
              - 'biome.*.json'
              - 'tailwind.config.*'
              - 'components.json'
            workflows:
              - '.github/workflows/**'
              - 'lefthook.yml'
              - 'commitlint.config.js'

  # –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è PR
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
            hotfix
          scopes: |
            components
            ui
            forms
            layout
            auth
            api
            hooks
            utils
            lib
            types
            contexts
            providers
            pages
            routes
            router
            styles
            assets
            icons
            config
            build
            deps
            env
            tests
            e2e
            mocks
            docs
            readme
            changelog
            ci
            cd
            scripts
            lint
            format
            hooks
            security
            perf
            a11y
            i18n

      - name: Check commit messages
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã –≤ PR
          git log --format="%s" origin/${{ github.base_ref }}..${{ github.sha }} > pr_commits.txt

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∫–æ–º–º–∏—Ç
          while IFS= read -r commit_msg; do
            echo "Checking commit: $commit_msg"
            echo "$commit_msg" | npx commitlint
          done < pr_commits.txt

  # –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥)
  code-checks:
    name: Code Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.config == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check TypeScript types
        run: bun run type-check

      - name: Run linting
        run: bun run lint

      - name: Check code formatting
        run: bun run format:check

      - name: Check for code duplication
        run: bun run check:duplicates

  # –¢–µ—Å—Ç—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –∫–æ–¥ –∏–ª–∏ —Ç–µ—Å—Ç—ã)
  tests:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.tests == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun run test:unit

      - name: Run integration tests
        run: bun run test:integration

      - name: Generate test coverage
        run: bun run test:coverage

      - name: Comment PR with coverage
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./coverage/lcov.info
          delete-old-comments: true

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –∫–æ–¥ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
  build:
    name: Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.config == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: bun run build

      - name: Check bundle size
        run: bun run build:analyze

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.config == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run security audit
        run: bun audit --audit-level=high

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.docs == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check markdown files
        uses: DavidAnson/markdownlint-action@v1
        with:
          files: '**/*.md'
          ignore: 'node_modules/**'
          config: |
            {
              "MD013": false,
              "MD033": false,
              "MD041": false
            }

      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/markdown-link-check.json'

  # –†–∞–∑–º–µ—Ä PR –ø—Ä–æ–≤–µ—Ä–∫–∞
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
          CHANGED_LINES=$(git diff --stat origin/${{ github.base_ref }}..${{ github.sha }} | tail -1 | grep -o '[0-9]\+ insertions\|[0-9]\+ deletions' | grep -o '[0-9]\+' | paste -sd+ | bc)

          echo "Changed lines: $CHANGED_LINES"

          # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö PR
          if [ "$CHANGED_LINES" -gt 1000 ]; then
            echo "‚ö†Ô∏è This PR is quite large ($CHANGED_LINES lines changed). Consider splitting it into smaller PRs."
            echo "::warning::Large PR detected ($CHANGED_LINES lines changed). Consider splitting into smaller PRs."
          elif [ "$CHANGED_LINES" -gt 500 ]; then
            echo "‚ÑπÔ∏è This PR is moderately large ($CHANGED_LINES lines changed)."
            echo "::notice::Moderately large PR ($CHANGED_LINES lines changed)."
          else
            echo "‚úÖ PR size is reasonable ($CHANGED_LINES lines changed)."
          fi

  # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö jobs
  pr-status:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: [pr-validation, code-checks, tests, build, security, docs, pr-size]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "PR Validation: ${{ needs.pr-validation.result }}"
          echo "Code Checks: ${{ needs.code-checks.result }}"
          echo "Tests: ${{ needs.tests.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Docs: ${{ needs.docs.result }}"
          echo "PR Size: ${{ needs.pr-size.result }}"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ jobs
          if [[ "${{ needs.pr-validation.result }}" != "success" ]]; then
            echo "‚ùå PR validation failed"
            exit 1
          fi

          if [[ "${{ needs.pr-size.result }}" != "success" ]]; then
            echo "‚ùå PR size check failed"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–Ω—ã–µ jobs (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å)
          if [[ "${{ needs.code-checks.result }}" == "failure" ]]; then
            echo "‚ùå Code checks failed"
            exit 1
          fi

          if [[ "${{ needs.tests.result }}" == "failure" ]]; then
            echo "‚ùå Tests failed"
            exit 1
          fi

          if [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "‚ùå Build failed"
            exit 1
          fi

          if [[ "${{ needs.security.result }}" == "failure" ]]; then
            echo "‚ùå Security checks failed"
            exit 1
          fi

          if [[ "${{ needs.docs.result }}" == "failure" ]]; then
            echo "‚ùå Documentation checks failed"
            exit 1
          fi

          echo "‚úÖ All PR checks passed successfully! üéâ"
