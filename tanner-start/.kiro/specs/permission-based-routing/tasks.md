# План реализации: Система маршрутизации на основе прав доступа

## Задачи

- [x] 1. Создать типы для системы прав доступа



  - Создать файл `src/types/permissions.ts` с базовыми типами прав доступа
  - Создать типы для конфигурации маршрутов в `src/types/routes.ts`
  - Добавить экспорт новых типов в `src/types/index.ts`
  - _Требования: 1.1, 1.2, 1.3, 7.1, 7.3_












- [ ] 2. Реализовать утилиты для работы с правами доступа
  - Создать файл `src/utils/permissions.ts`




  - Реализовать функцию `filterRoutesByPermissions` для фильтрации маршрутов на основе прав доступа пользователя
  - Реализовать функцию `checkRouteAccess` для проверки доступа к маршруту
  - Реализовать функцию `getFirstAccessibleRoute` для получения первого доступного маршрута
  - Реализовать функцию `isHiddenRoute` для проверки скрытых маршрутов
  - _Требования: 4.1, 4.2, 4.3, 3.1, 3.2, 1.5_





- [ ] 3. Создать API клиент для прав доступа
  - Создать файл `src/api/permissions.ts`
  - Реализовать функцию `fetchUserPermissions` для получения прав доступа с сервера
  - Добавить обработку ошибок и типизацию ответов



  - Интегрировать с существующим API клиентом (ky)
  - _Требования: 2.1, 2.3_


- [x] 4. Создать PermissionContext и PermissionProvider



  - Создать файл `src/contexts/PermissionContext.tsx`
  - Реализовать контекст с состоянием прав доступа, загрузкой и ошибками
  - Реализовать методы `hasPermission`, `hasAllPermissions`, `hasAnyPermission`
  - Реализовать метод `canAccessRoute` для проверки доступа к маршруту




  - Реализовать метод `refetchPermissions` для перезагрузки прав доступа
  - Добавить загрузку прав доступа при монтировании провайдера
  - Добавить фильтрацию маршрутов на основе прав доступа
  - Реализовать кэширование прав доступа



  - _Требования: 2.1, 2.2, 2.4, 2.5, 4.1, 4.5_







- [ ] 5. Создать хук usePermissionContext
  - Добавить хук `usePermissionContext` в файл `src/contexts/PermissionContext.tsx`
  - Добавить проверку использования хука внутри провайдера
  - Экспортировать хук для использования в компонентах
  - _Требования: 2.2, 4.1_

- [ ] 6. Создать конфигурацию маршрутов
  - Создать файл `src/config/routes.ts`
  - Определить структуру `ROUTES_CONFIG` с группами и маршрутами
  - Добавить права доступа для каждого маршрута на основе примера из requirements
  - Добавить поддержку ленивой загрузки компонентов
  - Добавить метаданные для групп и маршрутов
  - _Требования: 7.1, 7.2, 7.4, 7.5, 1.1, 1.2, 1.3_

- [ ] 7. Создать permission guard для TanStack Router
  - Создать файл `src/guards/permissionGuard.ts`
  - Реализовать функцию `createPermissionGuard` для создания guard с проверкой прав доступа
  - Добавить интеграцию с PermissionContext
  - Добавить редирект на доступный маршрут при отсутствии прав
  - Добавить обработку состояния загрузки прав доступа
  - Интегрировать с существующим authentication guard
  - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5, 6.1_

- [ ] 8. Обновить AuthContext для интеграции с правами доступа
  - Обновить файл `src/contexts/AuthContext.tsx`
  - Добавить вызов загрузки прав доступа после успешной аутентификации
  - Добавить очистку прав доступа при выходе из системы
  - _Требования: 2.1, 2.5_

- [ ] 9. Интегрировать PermissionProvider в приложение
  - Обновить файл `src/main.tsx`
  - Добавить `PermissionProvider` в дерево компонентов после `AuthProvider`
  - Передать конфигурацию маршрутов в провайдер
  - _Требования: 2.2, 6.3_

- [ ] 10. Обновить Navigation компонент для фильтрации меню
  - Обновить файл `src/components/common/Navigation.tsx`
  - Использовать `usePermissionContext` для получения отфильтрованных маршрутов
  - Отображать только доступные маршруты из `filteredRoutes.groupedRoutes`
  - Исключать маршруты с `isHideInMenu: true`
  - Добавить поддержку группировки маршрутов
  - Сохранить существующую функциональность локализации
  - _Требования: 4.1, 4.2, 4.3, 4.4, 4.5, 8.2_

- [ ] 11. Обновить authenticated layout для проверки прав доступа
  - Обновить файл `src/routes/$locale/_layout/_authenticated.tsx`
  - Добавить проверку загрузки прав доступа в `beforeLoad`
  - Добавить редирект на первый доступный маршрут при отсутствии прав
  - Сохранить существующую проверку аутентификации
  - Сохранить параметры локали при редиректах
  - _Требования: 3.1, 3.3, 3.5, 5.5, 6.2, 6.3, 8.1_

- [ ] 12. Обновить root route для редиректа с правами доступа
  - Обновить файл `src/routes/__root.tsx`
  - Добавить использование `usePermissionContext` для получения первого доступного маршрута
  - Обновить логику редиректа с учетом прав доступа
  - Сохранить существующую логику определения локали
  - _Требования: 3.1, 3.2, 3.5, 8.1_

- [ ] 13. Создать страницу "Доступ запрещен"
  - Создать компонент `src/components/common/AccessDenied.tsx`
  - Добавить локализованное сообщение об отсутствии прав доступа
  - Добавить кнопку возврата на главную страницу
  - Добавить отображение требуемых прав доступа (в dev режиме)
  - _Требования: 3.3, 5.2, 8.2_

- [ ] 14. Добавить обработку ошибок загрузки прав доступа
  - Создать компонент `src/components/common/PermissionError.tsx`
  - Добавить отображение ошибки загрузки прав доступа
  - Добавить кнопку повторной попытки загрузки
  - Интегрировать компонент в PermissionProvider
  - _Требования: 2.3_

- [ ] 15. Добавить компонент загрузки прав доступа
  - Создать или обновить компонент `src/components/common/Loading.tsx`
  - Добавить специальное состояние для загрузки прав доступа
  - Интегрировать в PermissionProvider для отображения во время загрузки
  - _Требования: 2.4_

- [ ] 16. Создать примеры использования с существующими маршрутами
  - Обновить файл `src/routes/$locale/_layout/_authenticated/dashboard.tsx`
  - Добавить `createPermissionGuard` с правами доступа для dashboard
  - Обновить файл `src/routes/$locale/_layout/_authenticated/admin.tsx`
  - Добавить `createPermissionGuard` с правами доступа для admin
  - Проверить работу с локализацией
  - _Требования: 6.1, 6.2, 6.4, 8.1, 8.3_

- [ ] 17. Добавить мемоизацию для оптимизации производительности
  - Обновить `src/contexts/PermissionContext.tsx`
  - Добавить `useMemo` для фильтрации маршрутов
  - Добавить `useCallback` для методов проверки прав доступа
  - Оптимизировать проверки прав доступа с использованием Set
  - _Требования: 2.5_

- [ ] 18. Создать документацию по использованию
  - Создать файл `docs/permissions-guide.md`
  - Описать, как добавлять новые маршруты с правами доступа
  - Описать, как использовать хуки и утилиты
  - Добавить примеры кода
  - Описать структуру прав доступа

- [ ] 19. Добавить логирование для отладки (dev режим)
  - Обновить `src/contexts/PermissionContext.tsx`
  - Добавить логирование загрузки прав доступа
  - Добавить логирование фильтрации маршрутов
  - Добавить логирование проверок прав доступа
  - Включать логирование только в dev режиме

- [ ] 20. Провести интеграционное тестирование
  - Проверить полный flow: вход → загрузка прав → фильтрация маршрутов → навигация
  - Проверить редиректы при отсутствии прав доступа
  - Проверить работу с разными наборами прав доступа
  - Проверить работу с локализацией
  - Проверить обработку ошибок
  - Проверить производительность при большом количестве маршрутов
